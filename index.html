<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FitGenius - Science Engine v17</title>
    <!-- Production Scripts with Fail-safe -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #09090b; color: #f4f4f5; margin: 0; padding: 0; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        /* Initial Loader to prevent black screen */
        #loading-screen { position: fixed; inset: 0; background: #09090b; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; }
        .spinner { width: 40px; height: 40px; border: 4px solid rgba(212, 240, 77, 0.1); border-top: 4px solid #d4f04d; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="loading-screen">
        <div class="spinner"></div>
        <p style="color: #52525b; font-size: 12px; margin-top: 20px; font-weight: bold; letter-spacing: 2px;">LOADING FITGENIUS...</p>
    </div>
    <div id="root"></div>

    <script type="text/babel">
        // --- 1. SETUP ---
        const { 
            Home, Dumbbell, History, Database, Plus, Check, Trash, Search, 
            X, Clock, Brain, Activity, ChevronUp, ChevronDown, 
            Download, Settings, Send, Bot, Layers, Lock, Unlock, 
            Save, ArrowUp, ArrowDown, Flame, Star, TrendingUp, Award, Target, Upload
        } = lucide;

        const MUSCLE_GROUPS = ['Chest', 'Back', 'Biceps', 'Glutes', 'Shoulders', 'Triceps', 'Abs', 'Lower back', 'Quads', 'Hamstrings', 'Calves', 'Adductors', 'Abductors', 'Forearms', 'Trapezius'];
        
        const MASTER_DB = [
            { id: 'ex1', name: 'Leg Press', muscle: 'Quads', type: 'Compound', defaultRest: 120 },
            { id: 'ex2', name: 'Seated Cable RDL', muscle: 'Hamstrings', type: 'Compound', defaultRest: 120 },
            { id: 'ex3', name: 'Leg Extension', muscle: 'Quads', type: 'Isolation', defaultRest: 120 },
            { id: 'ex4', name: 'Machine Adduction', muscle: 'Adductors', type: 'Isolation', defaultRest: 120 },
            { id: 'ex5', name: 'Machine Abduction', muscle: 'Abductors', type: 'Isolation', defaultRest: 120 },
            { id: 'ex6', name: 'Lying Hamstring Curl', muscle: 'Hamstrings', type: 'Isolation', defaultRest: 120 },
            { id: 'ex7', name: 'Smith Machine Incline Press', muscle: 'Chest', type: 'Compound', defaultRest: 120 },
            { id: 'ex8', name: 'T-Bar Row Wide Grip', muscle: 'Back', type: 'Compound', defaultRest: 120 },
            { id: 'ex9', name: 'Dumbbell Shoulder Press', muscle: 'Shoulders', type: 'Compound', defaultRest: 120 },
            { id: 'ex10', name: 'Lat Pulldown', muscle: 'Back', type: 'Compound', defaultRest: 120 },
            { id: 'ex11', name: 'Cable Face Pull', muscle: 'Back', type: 'Isolation', defaultRest: 120 },
            { id: 'ex12', name: 'Machine Chest Fly', muscle: 'Chest', type: 'Isolation', defaultRest: 120 },
            { id: 'ex13', name: 'Tricep Pushdown', muscle: 'Triceps', type: 'Isolation', defaultRest: 120 },
            { id: 'ex14', name: 'Incline Dumbbell Curl', muscle: 'Biceps', type: 'Isolation', defaultRest: 120 }
        ];

        // --- 2. ENGINE ---
        function App() {
            const [view, setView] = React.useState('home');
            const [modal, setModal] = React.useState(null);

            const load = (k, d) => { try { const v = localStorage.getItem(k); return v ? JSON.parse(v) : d; } catch(e) { return d; } };
            
            const [logs, setLogs] = React.useState(() => load('fg_v17_logs', []));
            const [routines, setRoutines] = React.useState(() => load('fg_v17_routines', []));
            const [customEx, setCustomEx] = React.useState(() => load('fg_v17_custom', []));
            const [favorites, setFavorites] = React.useState(() => load('fg_v17_favs', []));
            const [collapsed, setCollapsed] = React.useState(() => load('fg_v17_coll', []));
            const [apiKey, setApiKey] = React.useState(() => localStorage.getItem('fg_v17_key') || '');
            const [isLocked, setIsLocked] = React.useState(() => localStorage.getItem('fg_v17_lock') === 'true');

            const [activeSession, setActiveSession] = React.useState(null);
            const [rest, setRest] = React.useState(0);
            const [isAnalyzing, setIsAnalyzing] = React.useState(false);
            const [analysisResult, setAnalysisResult] = React.useState(null);

            const [picker, setPicker] = React.useState(null); // { targetId, selectedIds }
            const [search, setSearch] = React.useState('');
            const [cat, setCat] = React.useState('All');
            const [formName, setFormName] = React.useState('');

            const allDB = React.useMemo(() => [...MASTER_DB, ...customEx], [customEx]);

            useEffect(() => {
                localStorage.setItem('fg_v17_logs', JSON.stringify(logs));
                localStorage.setItem('fg_v17_routines', JSON.stringify(routines));
                localStorage.setItem('fg_v17_custom', JSON.stringify(customEx));
                localStorage.setItem('fg_v17_favs', JSON.stringify(favorites));
                localStorage.setItem('fg_v17_coll', JSON.stringify(collapsed));
                localStorage.setItem('fg_v17_key', apiKey);
                localStorage.setItem('fg_v17_lock', isLocked);
                // Remove loader once app is ready
                const loader = document.getElementById('loading-screen');
                if (loader) loader.style.display = 'none';
            }, [logs, routines, customEx, favorites, collapsed, apiKey, isLocked]);

            useEffect(() => {
                if (rest <= 0) return;
                const timer = setInterval(() => setRest(r => r - 1), 1000);
                return () => clearInterval(timer);
            }, [rest]);

            // --- 3. ACTIONS ---

            const runProgressAnalysis = async (log) => {
                if (!apiKey) return;
                setIsAnalyzing(true);
                const prev = logs.find(l => l.routineName === log.routineName && l.id < log.id);
                const sys = `คุณคือ Science Gym Bro วิเคราะห์ Progressive Overload
                กฎ: บรรทัด 1 SCORE: [0-100], บรรทัด 2 RECOM: [สั้นๆ], ตามด้วยบทวิเคราะห์ (ไทย, กันเอง)
                เปรียบเทียบ: เก่า=${JSON.stringify(prev?.exercises||[])}, ใหม่=${JSON.stringify(log.exercises)}`;
                
                try {
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ contents: [{ parts: [{ text: "Evaluate my session" }] }], systemInstruction: { parts: [{ text: sys }] } })
                    });
                    const d = await res.json();
                    const txt = d.candidates?.[0]?.content?.parts?.[0]?.text || "";
                    const score = parseInt(txt.match(/SCORE:\s*(\d+)/)?.[1] || "0");
                    const recom = txt.match(/RECOM:\s*(.*)/)?.[1] || "ทำได้ดีมาก";
                    const content = txt.replace(/SCORE:.*\n?/, "").replace(/RECOM:.*\n?/, "").trim();
                    setAnalysisResult({ score, recommendation: recom, content });
                } catch (e) { alert("AI Error: Check Key/Connection"); }
                setIsAnalyzing(false);
            };

            const startWorkout = (r = null) => {
                const warmed = new Set();
                const session = {
                    id: Date.now(), name: r ? r.name : 'FREESTYLE', startTime: Date.now(),
                    exercises: (r?.exercises || []).map(item => {
                        const ref = allDB.find(e => e.id === item.id) || { name: 'Unknown', muscle: 'Other' };
                        const needsW = !warmed.has(ref.muscle); if (needsW) warmed.add(ref.muscle);
                        const sets = [];
                        if (needsW) {
                            sets.push({ id: Math.random(), weight: '', reps: '15', done: false, type: 'warmup', p: 30 });
                            sets.push({ id: Math.random(), weight: '', reps: '8', done: false, type: 'warmup', p: 60 });
                        }
                        sets.push({ id: Math.random(), weight: '', reps: '', done: false, type: 'work' });
                        sets.push({ id: Math.random(), weight: '', reps: '', done: false, type: 'work' });
                        sets.push({ id: Math.random(), weight: '', reps: '', rir: '', done: false, type: 'work' });
                        return { id: Math.random(), name: ref.name, muscle: ref.muscle, rest: item.rest || 120, sets };
                    })
                };
                setActiveSession(session);
                setModal(null);
            };

            const finishWorkout = () => {
                const valid = activeSession.exercises.map(ex => ({
                    name: ex.name, muscle: ex.muscle, sets: ex.sets.filter(s => s.done && (s.weight || s.reps))
                })).filter(ex => ex.sets.length > 0);
                if (valid.length > 0) {
                    const newLog = { id: Date.now(), routineName: activeSession.name, date: new Date().toLocaleDateString('th-TH'), exercises: valid };
                    setLogs(p => [newLog, ...p]);
                    runProgressAnalysis(newLog);
                }
                setActiveSession(null); setRest(0); setModal(null); setView('history');
            };

            return (
                <div className="max-w-md mx-auto min-h-screen flex flex-col relative overflow-x-hidden select-none">
                    {/* Header */}
                    <header className="p-6 sticky top-0 bg-[#09090b]/95 backdrop-blur-md z-40 border-b border-zinc-900 flex justify-between items-center">
                        <div><h1 className="text-xl font-black italic text-[#d4f04d]">FITGENIUS</h1><p className="text-[7px] font-bold text-zinc-600 uppercase">Science Lab v17</p></div>
                        <div className="flex items-center gap-2"><div className={`w-1.5 h-1.5 rounded-full ${isOnline ? 'bg-green-500 animate-pulse' : 'bg-red-500'}`}></div><span className="text-[8px] font-black uppercase text-zinc-500">{isOnline ? 'LIVE' : 'OFF'}</span></div>
                    </header>

                    {/* Content View */}
                    <main className="p-5 flex-1 pb-32">
                        {activeSession ? (
                            <div className="space-y-6 animate-in">
                                <div className="flex justify-between items-center bg-zinc-900/50 p-4 rounded-3xl border border-zinc-800 shadow-xl">
                                    <h2 className="font-black uppercase text-[#d4f04d] italic text-sm truncate max-w-[150px]">{activeSession.name}</h2>
                                    <button onClick={() => setModal('finish')} className="bg-[#d4f04d] text-black px-6 py-2 rounded-2xl font-black text-xs uppercase shadow-lg">FINISH</button>
                                </div>
                                {activeSession.exercises.map((ex, exIdx) => (
                                    <div key={exIdx} className="bg-[#18181b] p-5 rounded-[2.5rem] border border-zinc-800 shadow-xl">
                                        <div className="flex justify-between items-start mb-4">
                                            <div className="flex-1"><h3 className="text-sm font-black uppercase text-zinc-100">{ex.name}</h3><p className="text-[7px] font-black text-zinc-600 mt-1 uppercase">Rest: {ex.rest}s • {ex.muscle}</p></div>
                                            <button onClick={()=>{const ns={...activeSession}; ns.exercises.splice(exIdx,1); setActiveSession(ns);}} className="text-zinc-800"><X size={16}/></button>
                                        </div>
                                        <div className="space-y-2">
                                            <div className="flex text-[6px] font-black text-zinc-700 uppercase px-1"><div className="w-8">SET</div><div className="flex-1 text-center">KG</div><div className="flex-1 text-center">REPS</div><div className="w-10">RIR</div><div className="w-10"></div></div>
                                            {ex.sets.map((set, sIdx) => {
                                                const isL = sIdx === ex.sets.length - 1;
                                                const fw = ex.sets.find(s=>s.type==='work')?.weight||0;
                                                const ww = set.type==='warmup'?Math.round(fw*(set.p/100)):0;
                                                return (
                                                    <div key={set.id} className={`flex items-center gap-2 ${set.done?'opacity-30 scale-[0.98]':''}`}>
                                                        <div className={`w-8 text-[9px] font-black italic ${set.type==='warmup'?'text-blue-500':'text-zinc-700'}`}>{set.type==='warmup'?`W${sIdx+1}`:(ex.sets.filter((_,i)=>i<sIdx&&ex.sets[i].type==='work').length+1)}</div>
                                                        <input type="number" placeholder={set.type==='warmup'?ww:''} disabled={set.type==='warmup'} value={set.type==='warmup'?'':set.weight} onChange={e=>{const ns={...activeSession}; ns.exercises[exIdx].sets[sIdx].weight=e.target.value; setActiveSession(ns);}} className={`flex-1 bg-black h-10 rounded-xl text-center font-black text-sm outline-none border ${set.type==='warmup'?'border-blue-900/10 text-blue-500/50':'border-zinc-900 focus:border-[#d4f04d]'}`} />
                                                        <input type="number" placeholder="-" value={set.reps} onChange={e=>{const ns={...activeSession}; ns.exercises[exIdx].sets[sIdx].reps=e.target.value; setActiveSession(ns);}} className="flex-1 bg-black h-10 rounded-xl text-center font-black text-sm outline-none border border-zinc-900 focus:border-[#d4f04d]" />
                                                        <div className="w-10">{isL && set.type==='work' ? <input type="number" placeholder="RIR" value={set.rir} onChange={e=>{const ns={...activeSession}; ns.exercises[exIdx].sets[sIdx].rir=e.target.value; setActiveSession(ns);}} className="w-full bg-zinc-900 h-10 rounded-xl text-center font-black text-[8px] text-[#d4f04d] border border-zinc-800" /> : null}</div>
                                                        <button onClick={()=>{const ns={...activeSession}; ns.exercises[exIdx].sets[sIdx].done=!set.done; if(!set.done&&rest===0) setRest(ex.rest); setActiveSession(ns);}} className={`w-10 h-10 rounded-xl flex items-center justify-center ${set.done?'bg-[#d4f04d] text-black shadow-lg shadow-[#d4f04d]/20':'bg-zinc-900 text-zinc-700 border border-zinc-800'}`}><Check size={18} strokeWidth={4}/></button>
                                                    </div>
                                                )
                                            })}
                                            <button onClick={()=>{const ns={...activeSession}; ns.exercises[exIdx].sets.push({id:Math.random(),weight:'',reps:'',done:false,type:'work'}); setActiveSession(ns);}} className="w-full py-2 border border-dashed border-zinc-800 rounded-xl text-[8px] font-black uppercase text-zinc-700 tracking-widest">+ Add Set</button>
                                        </div>
                                    </div>
                                ))}
                                <button onClick={() => setPicker({ targetId: 'live', selectedIds: [] })} className="w-full py-8 border-2 border-dashed border-zinc-800 rounded-[3rem] font-black uppercase text-zinc-700 tracking-widest bg-zinc-900/10 flex items-center justify-center gap-3 active:scale-95"><Plus size={24}/> Add Movement</button>
                                {rest > 0 && (
                                    <div className="fixed bottom-10 left-5 right-5 bg-blue-600 p-6 rounded-[2.5rem] flex justify-between items-center shadow-2xl z-[120] animate-bounce"><div className="flex items-center gap-4 text-white"><Clock size={28} /><p className="text-4xl font-black font-mono">{Math.floor(rest/60)}:{(rest%60).toString().padStart(2, '0')}</p></div><button onClick={() => setRest(0)} className="bg-white text-blue-600 px-6 py-2 rounded-xl font-black text-xs uppercase">Skip</button></div>
                                )}
                            </div>
                        ) : view === 'home' ? (
                            <div className="space-y-8 animate-in">
                                <div className="bg-[#18181b] p-8 rounded-[3rem] border border-zinc-800 shadow-2xl relative overflow-hidden flex justify-between items-end">
                                    <div><p className="text-[10px] font-black text-zinc-600 uppercase tracking-widest mb-1">Session Count</p><h2 className="text-6xl font-black italic text-white tracking-tighter leading-none">{logs.length}</h2></div>
                                    <Activity className="absolute -right-4 -bottom-4 text-[#d4f04d]/5" size={150}/>
                                </div>
                                <div className="space-y-4">
                                    <h3 className="text-[10px] font-black text-zinc-600 uppercase tracking-widest px-2 flex items-center gap-2"><Star size={12} className="text-[#d4f04d]"/> Favorites</h3>
                                    {favorites.length === 0 ? <div className="p-10 text-center border-2 border-dashed border-zinc-900 rounded-[2.5rem] text-zinc-800 font-black text-[9px] uppercase">No favorites yet</div> : (
                                        <div className="grid grid-cols-1 gap-3">
                                            {favorites.map(fid => {
                                                const r = routines.find(x=>x.id===fid); if(!r) return null;
                                                return (<button key={fid} onClick={()=>startWorkout(r)} className="bg-[#d4f04d] text-black p-5 rounded-[2rem] flex justify-between items-center active:scale-95 shadow-xl"><div><p className="font-black italic uppercase text-md leading-none text-left">{r.name}</p><p className="text-[8px] font-bold uppercase mt-1 opacity-50 text-left">{r.exercises.length} Exercises</p></div><TrendingUp size={20}/></button>)
                                            })}
                                        </div>
                                    )}
                                </div>
                            </div>
                        ) : view === 'train' ? (
                            <div className="space-y-6 animate-in">
                                <div className="flex justify-between items-center px-2"><h2 className="text-[10px] font-black text-zinc-600 uppercase tracking-widest">Program Lab</h2><button onClick={()=>setModal('create')} className="bg-[#d4f04d]/10 text-[#d4f04d] px-4 py-2 rounded-xl text-[9px] font-black border border-[#d4f04d]/20 uppercase">+ New</button></div>
                                {routines.map(r => {
                                    const isC = collapsed.includes(r.id); const isF = favorites.includes(r.id);
                                    return (
                                        <div key={r.id} className="bg-[#18181b] rounded-[2.5rem] border border-zinc-800 shadow-xl overflow-hidden mb-4">
                                            <div className="p-5 flex justify-between items-center bg-zinc-900/30 cursor-pointer" onClick={()=>setCollapsed(p=>isC?p.filter(x=>x!==r.id):[...p, r.id])}>
                                                <div className="flex items-center gap-3"><button onClick={e=>{e.stopPropagation(); setFavorites(p=>isF?p.filter(x=>x!==r.id):[...p, r.id]);}} className={`p-2 rounded-xl ${isF?'text-yellow-400':'text-zinc-800'}`}><Star size={16} fill={isF?"currentColor":"none"}/></button><h3 className="text-md font-black text-white italic uppercase tracking-tighter">{r.name}</h3></div>
                                                <div className="flex items-center gap-2"><button onClick={e=>{e.stopPropagation(); if(confirm("ลบโปรแกรม?")) setRoutines(p=>p.filter(x=>x.id!==r.id));}} className="text-zinc-800 hover:text-red-500 p-2"><Trash size={14}/></button>{isC ? <ChevronDown size={18}/> : <ChevronUp size={18}/>}</div>
                                            </div>
                                            {!isC && (
                                                <div className="p-5 pt-0 space-y-4">
                                                    <div className="space-y-2">{r.exercises.map((item, idx) => {
                                                        const ex = allDB.find(e=>e.id===item.id) || {name:'Unknown'};
                                                        return (<div key={idx} className="bg-black p-3 rounded-2xl border border-zinc-800/50 flex items-center gap-3"><div className="flex flex-col"><button onClick={()=>{const nx=[...r.exercises]; if(idx>0){[nx[idx],nx[idx-1]]=[nx[idx-1],nx[idx]]; setRoutines(p=>p.map(rt=>rt.id===r.id?{...rt,exercises:nx}:rt));}}}><ArrowUp size={12}/></button><button onClick={()=>{const nx=[...r.exercises]; if(idx<nx.length-1){[nx[idx],nx[idx+1]]=[nx[idx+1],nx[idx]]; setRoutines(p=>p.map(rt=>rt.id===r.id?{...rt,exercises:nx}:rt));}}}><ArrowDown size={12}/></button></div><div className="flex-1"><p className="text-[11px] font-black text-zinc-300 uppercase leading-none">{ex.name}</p><div className="flex items-center gap-1 text-[7px] text-zinc-600 mt-1 uppercase">Rest: <input type="number" value={item.rest} onChange={e=>setRoutines(p=>p.map(rt=>rt.id===r.id?{...rt,exercises:rt.exercises.map((x,i)=>i===idx?{...x,rest:parseInt(e.target.value)}:x)}:rt))} className="bg-transparent w-8 text-blue-500 border-b border-blue-900/30" />s</div></div><button onClick={()=>{const nx=[...r.exercises]; nx.splice(idx,1); setRoutines(p=>p.map(rt=>rt.id===r.id?{...rt,exercises:nx}:rt));}}><X size={14}/></button></div>)
                                                    })}</div>
                                                    <div className="flex gap-2"><button onClick={()=>setPicker({targetId:r.id,selectedIds:[]})} className="flex-1 py-4 rounded-2xl bg-zinc-900 border border-zinc-800 text-[8px] font-black uppercase tracking-widest">+ Add Move</button><button onClick={()=>startWorkout(r)} className="flex-1 py-4 rounded-2xl bg-[#d4f04d] text-black text-[9px] font-black uppercase shadow-lg shadow-[#d4f04d]/20 active:scale-95 transition-all">Start</button></div>
                                                </div>
                                            )}
                                        </div>
                                    )
                                })}
                            </div>
                        ) : view === 'history' ? (
                            <div className="space-y-6 animate-in">
                                <h2 className="text-[10px] font-black text-zinc-600 uppercase tracking-widest px-2">History</h2>
                                {logs.length === 0 ? <p className="text-center py-20 text-zinc-700 font-black uppercase text-xs">ยังไม่มีประวัติการฝึก</p> : logs.map(log => (
                                    <div key={log.id} className="bg-[#18181b] p-6 rounded-[2.5rem] border border-zinc-800 shadow-xl mb-4">
                                        <div className="flex justify-between items-start mb-4 border-b border-zinc-800/50 pb-4">
                                            <div><h3 className="text-sm font-black text-[#d4f04d] italic uppercase">{log.routineName}</h3><p className="text-[8px] text-zinc-600 uppercase font-black">{log.date}</p></div>
                                            <div className="flex gap-2"><button onClick={()=>runProgressAnalysis(log)} className="bg-blue-900/20 text-blue-400 p-2 rounded-xl border border-blue-900/30"><Brain size={16}/></button><button onClick={()=>setLogs(p=>p.filter(x=>x.id!==log.id))} className="text-zinc-800"><Trash size={16}/></button></div>
                                        </div>
                                        <div className="space-y-3">{log.exercises.map((ex, i) => (
                                            <div key={i}><p className="text-[10px] font-bold text-white uppercase">{ex.name}</p><div className="flex flex-wrap gap-1 mt-1">{ex.sets.map((s, si)=>(<span key={si} className="text-[8px] bg-black px-2 py-1 rounded-lg border border-zinc-800 font-mono text-zinc-400">{s.weight}kg x {s.reps}</span>))}</div></div>
                                        ))}</div>
                                    </div>
                                ))}
                            </div>
                        ) : view === 'library' ? (
                            <div className="space-y-6 animate-in">
                                <div className="flex justify-between items-center px-2"><h2 className="text-[10px] font-black text-zinc-600 uppercase tracking-widest">Library</h2><button onClick={()=>setModal('custom')} className="bg-[#d4f04d] text-black px-3 py-1 rounded-xl text-[8px] font-black uppercase shadow-lg">+ Custom</button></div>
                                <div className="flex gap-2 overflow-x-auto no-scrollbar pb-2">{MUSCLE_GROUPS.map(m=>(<button key={m} onClick={()=>setCat(m)} className={`px-4 py-2 rounded-full text-[9px] font-black uppercase border transition-all whitespace-nowrap ${cat===m?'bg-[#d4f04d] text-black border-transparent shadow-lg':'bg-zinc-900 text-zinc-600 border-zinc-800'}`}>{m}</button>))}</div>
                                <div className="bg-[#18181b] p-4 rounded-3xl border border-zinc-800 flex items-center gap-3"><Search size={16} className="text-zinc-700" /><input type="text" placeholder="Search anatomy..." value={search} onChange={e=>setSearch(e.target.value)} className="bg-transparent w-full outline-none font-black italic text-md text-white placeholder:text-zinc-900" /></div>
                                <div className="space-y-4">{filteredLibrary.map(ex => (
                                    <div key={ex.id} className="bg-[#18181b] p-6 rounded-[2rem] border border-zinc-800 flex justify-between items-center shadow-xl"><div><p className="font-black text-zinc-100 uppercase italic text-sm">{ex.name}</p><p className="text-[8px] text-zinc-600 font-black mt-1 uppercase tracking-widest">{ex.muscle} • {ex.type}</p></div>{ex.id.startsWith('c_') && <button onClick={()=>setCustomEx(p=>p.filter(x=>x.id!==ex.id))} className="text-zinc-800"><Trash size={16}/></button>}</div>
                                ))}</div>
                            </div>
                        ) : (
                            <div className="p-5 space-y-6 animate-in">
                                <div className="bg-[#18181b] p-8 rounded-[3.5rem] border border-zinc-800 shadow-xl space-y-8 text-center">
                                    <h3 className="text-xl font-black text-[#d4f04d] uppercase italic tracking-tighter">Settings</h3>
                                    <div className="space-y-4 text-left">
                                        <div className="flex justify-between items-center"><label className="text-[10px] font-black text-zinc-600 uppercase tracking-widest">Gemini API Key</label><button onClick={()=>setIsLocked(!isLocked)} className="p-2 bg-zinc-900 rounded-xl border border-zinc-800">{isLocked?<Lock size={14}/>:<Unlock size={14}/>}</button></div>
                                        <div className="relative"><input type={isLocked?"password":"text"} value={apiKey} onChange={e=>setApiKey(e.target.value)} disabled={isLocked} placeholder="Paste key here..." className="w-full bg-black p-4 rounded-2xl border border-zinc-800 text-zinc-400 outline-none focus:border-[#d4f04d] transition-all" />{!isLocked && <button onClick={()=>setIsLocked(true)} className="absolute right-2 top-2 p-2 bg-[#d4f04d] text-black rounded-xl"><Check size={20}/></button>}</div>
                                    </div>
                                    <div className="grid grid-cols-2 gap-4 border-t border-zinc-900 pt-6">
                                        <button onClick={()=>{const d=JSON.stringify({logs,routines,customEx,favorites}); const b=new Blob([d],{type:'application/json'}); const u=URL.createObjectURL(b); const a=document.createElement('a'); a.href=u; a.download='FitGenius_Backup.json'; a.click();}} className="bg-zinc-900 p-6 rounded-3xl flex flex-col items-center gap-3"><Download size={24} className="text-[#d4f04d]"/><span className="text-[8px] font-black uppercase text-zinc-500">Export</span></button>
                                        <label className="bg-zinc-900 p-6 rounded-3xl flex flex-col items-center gap-3 cursor-pointer"><Upload size={24} className="text-blue-500"/><span className="text-[8px] font-black uppercase text-zinc-500">Import</span><input type="file" accept=".json" onChange={e => { const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=ev=>{try{const p=JSON.parse(ev.target.result); if(p.logs) setLogs(p.logs); if(p.routines) setRoutines(p.routines); if(p.customEx) setCustomEx(p.customEx); if(p.favorites) setFavorites(p.favorites); alert("Success!");}catch(e){alert("Error!");}}; r.readAsText(f);}} className="hidden"/></label>
                                    </div>
                                </div>
                            </div>
                        )}
                    </main>

                    {/* Navigation Bar */}
                    {!activeSession && (
                        <nav className="fixed bottom-6 left-1/2 -translate-x-1/2 w-[92%] max-w-sm bg-[#18181b]/95 backdrop-blur-xl border border-zinc-800 p-3 rounded-[3rem] flex justify-around gap-2 z-50 shadow-[0_20px_40px_rgba(0,0,0,0.8)]">
                            {[{id:'home',icon:Home},{id:'train',icon:Layers},{id:'history',icon:History},{id:'library',icon:Database},{id:'data',icon:Settings}].map(item => (
                                <button key={item.id} onClick={() => setView(item.id)} className={`flex items-center justify-center w-12 h-12 rounded-full transition-all duration-300 ${view === item.id ? 'bg-[#d4f04d] text-black shadow-lg scale-110 -translate-y-2' : 'text-zinc-700 hover:text-zinc-500'}`}><Icon name={item.icon} size={20} strokeWidth={view === item.id ? 3 : 2} /></button>
                            ))}
                        </nav>
                    )}

                    {/* All Internal Modals Render Here */}
                    {modal === 'finish' && (
                        <div className="fixed inset-0 bg-black/95 z-[300] flex items-center justify-center p-8 backdrop-blur-md animate-in"><div className="bg-[#18181b] p-10 rounded-[3.5rem] w-full max-w-sm text-center border border-zinc-800 shadow-2xl"><h3 className="text-xl font-black text-zinc-100 uppercase italic mb-8 tracking-tighter">Session Finish?</h3><button onClick={finishWorkout} className="w-full bg-[#d4f04d] text-black py-5 rounded-[2rem] font-black uppercase text-xs shadow-xl shadow-[#d4f04d]/20 active:scale-95 mb-4">DONE & SAVE</button><button onClick={()=>setModal(null)} className="text-zinc-700 uppercase font-black text-[9px] tracking-widest py-2">Keep Lifting</button></div></div>
                    )}
                    {modal === 'create' && (
                        <div className="fixed inset-0 bg-black/90 z-[300] flex items-center justify-center p-8 backdrop-blur-md animate-in"><div className="bg-[#18181b] p-8 rounded-[3.5rem] w-full border border-zinc-800 shadow-2xl space-y-6"><h3 className="text-xl font-black text-[#d4f04d] uppercase italic text-center tracking-tighter">New Program</h3><input autoFocus type="text" value={formName} onChange={e=>setFormName(e.target.value)} placeholder="Program Name..." className="w-full bg-black p-5 rounded-2xl border border-zinc-800 text-white font-black italic outline-none focus:border-[#d4f04d]" /><div className="flex flex-col gap-3"><button onClick={()=>{if(formName.trim()){setRoutines([{id:'p_'+Date.now(), name:formName, exercises:[]}, ...routines]); setFormName(''); setModal(null);}}} className="bg-[#d4f04d] text-black py-5 rounded-[2rem] font-black uppercase text-xs">Create</button><button onClick={()=>setModal(null)} className="text-zinc-700 font-black uppercase text-[9px] py-2 text-center">Cancel</button></div></div></div>
                    )}
                    {modal === 'custom' && (
                        <div className="fixed inset-0 bg-black/90 z-[300] flex items-center justify-center p-8 backdrop-blur-md animate-in"><div className="bg-[#18181b] p-8 rounded-[3.5rem] w-full border border-zinc-800 shadow-2xl space-y-6"><h3 className="text-xl font-black text-[#d4f04d] uppercase italic text-center tracking-tighter">New Custom Move</h3><input type="text" value={formName} onChange={e=>setFormName(e.target.value)} placeholder="Exercise Name..." className="w-full bg-black p-5 rounded-2xl border border-zinc-800 text-white font-black italic outline-none focus:border-[#d4f04d]" /><select id="mselect" className="w-full bg-black p-5 rounded-2xl border border-zinc-800 text-[#d4f04d] font-black uppercase text-xs">{MUSCLE_GROUPS.map(m=><option key={m} value={m}>{m}</option>)}</select><div className="flex flex-col gap-3 pt-4"><button onClick={()=>{if(formName){const ms=document.getElementById('mselect').value; setCustomEx([{id:'c_'+Date.now(), name:formName, muscle:ms, type:'Custom'}, ...customEx]); setFormName(''); setModal(null);}}} className="bg-[#d4f04d] text-black py-5 rounded-[2rem] font-black uppercase text-xs">Create</button><button onClick={()=>setModal(null)} className="text-zinc-700 font-black uppercase text-[9px] py-2 text-center">Cancel</button></div></div></div>
                    )}
                    {picker && (
                        <div className="fixed inset-0 bg-[#09090b] z-[400] flex flex-col p-8 pt-16 overflow-hidden animate-in">
                            <div className="flex justify-between items-center mb-10 shrink-0"><h2 className="text-3xl font-black italic uppercase text-white tracking-tighter leading-none">Choose</h2><div className="flex gap-2"><button onClick={()=>setPicker(null)} className="text-zinc-700 font-black uppercase text-[9px] px-4">Cancel</button><button onClick={()=>{ if(picker.targetId==='live'){ const nx=picker.selectedIds.map(id=>{const ref=allDB.find(e=>e.id===id); return {id:Math.random(), name:ref.name, muscle:ref.muscle, rest:120, sets:Array(5).fill(null).map(()=>({id:Math.random(),weight:'',reps:'',done:false,type:'work'}))};}); setActiveSession({...activeSession, exercises:[...activeSession.exercises, ...nx]}); } else { setRoutines(routines.map(r=>r.id===picker.targetId?{...r,exercises:[...r.exercises, ...picker.selectedIds.map(id=>({id,rest:120}))]}:r)); } setPicker(null);}} disabled={picker.selectedIds.length===0} className="bg-[#d4f04d] text-black font-black uppercase text-[9px] px-5 py-2 rounded-xl disabled:opacity-30">Add ({picker.selectedIds.length})</button></div></div>
                            <div className="flex-1 overflow-y-auto space-y-3 pb-32 no-scrollbar">
                                {allDB.map(ex => {
                                    const isS = picker.selectedIds.includes(ex.id);
                                    const inR = picker.targetId !== 'live' && routines.find(r=>r.id===picker.targetId)?.exercises.some(e=>e.id===ex.id);
                                    return (<div key={ex.id} onClick={()=>!inR && setPicker(p=>({...p, selectedIds:isS?p.selectedIds.filter(i=>i!==ex.id):[...p.selectedIds, ex.id]}))} className={`bg-[#18181b] p-6 rounded-[2.5rem] border flex justify-between items-center transition-all ${isS?'border-[#d4f04d] bg-[#d4f04d]/5 scale-[0.98]':'border-zinc-800'} ${inR?'opacity-30':'cursor-pointer active:scale-95'}`}><div className="flex-1 pr-4"><p className={`font-black text-xl uppercase italic leading-none ${isS?'text-[#d4f04d]':'text-white'}`}>{ex.name}</p><p className="text-[8px] text-zinc-700 font-black uppercase mt-1 tracking-widest">{ex.muscle}</p></div><div className={`w-10 h-10 rounded-2xl flex items-center justify-center border-2 ${isS?'bg-[#d4f04d] border-transparent text-black':'border-zinc-800 text-zinc-900'}`}>{isS?<Check size={18} strokeWidth={4}/>:<Plus size={18}/>}</div></div>)
                                })}
                            </div>
                        </div>
                    )}
                    {analysisResult && (
                        <div className="fixed inset-0 bg-black/95 z-[500] flex items-center justify-center p-6 backdrop-blur-md animate-in overflow-hidden"><div className="bg-[#18181b] p-8 rounded-[3.5rem] w-full max-w-sm border border-zinc-800 shadow-2xl flex flex-col max-h-[85vh] overflow-hidden"><div className="flex justify-between items-start mb-6 shrink-0"><div className="flex items-center gap-3 text-blue-400"><Brain size={28}/><h3 className="text-xl font-black uppercase italic leading-none">Science Report</h3></div><button onClick={()=>setAnalysisResult(null)}><X size={20}/></button></div><div className="flex-1 overflow-y-auto space-y-8 pr-2 no-scrollbar"><div className="bg-zinc-900 p-6 rounded-[2.5rem] border border-zinc-800 text-center relative overflow-hidden"><p className="text-[10px] font-black text-zinc-600 uppercase tracking-widest mb-2">Progress Score</p><h4 className={`text-6xl font-black italic ${analysisResult.score>=80?'text-[#d4f04d]':'text-blue-400'}`}>{analysisResult.score}%</h4><div className="mt-4 h-2 bg-zinc-800 rounded-full overflow-hidden"><div className="h-full bg-[#d4f04d]" style={{width:`${analysisResult.score}%`}}></div></div><Award className="absolute -right-4 -bottom-4 text-white/5" size={100} /></div><div className="bg-[#d4f04d]/5 border border-[#d4f04d]/20 p-5 rounded-3xl"><div className="flex items-center gap-2 text-[#d4f04d] mb-1"><Target size={14}/><span className="text-[10px] font-black uppercase tracking-widest">Next Action</span></div><p className="text-xs font-bold text-white leading-relaxed">{analysisResult.recommendation}</p></div><div className="space-y-4"><div className="flex items-center gap-2 text-zinc-500"><Activity size={14}/><span className="text-[10px] font-black uppercase tracking-widest">Analysis</span></div><div className="text-xs leading-relaxed text-zinc-400 font-medium whitespace-pre-wrap border-l border-zinc-800 pl-4 py-1">{analysisResult.content}</div></div></div><button onClick={()=>setAnalysisResult(null)} className="w-full mt-6 bg-zinc-900 py-4 rounded-[2rem] font-black uppercase text-[10px] tracking-widest text-zinc-400 border border-zinc-800 active:scale-95 transition-all">Dismiss</button></div></div>
                    ) || isAnalyzing && (
                        <div className="fixed inset-0 bg-black/95 z-[500] flex items-center justify-center p-8 backdrop-blur-md animate-in"><div className="bg-[#18181b] p-8 rounded-[3.5rem] w-full max-w-xs border border-zinc-800 shadow-2xl flex flex-col items-center py-16"><div className="w-16 h-16 border-4 border-[#d4f04d]/20 border-t-[#d4f04d] rounded-full animate-spin mb-6"></div><p className="text-zinc-600 font-black uppercase tracking-widest text-[9px]">Coach is calculating gains...</p></div></div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
